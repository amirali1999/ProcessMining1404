{% extends "base.html" %}
{% block title %}فایل‌ها{% endblock %}
{% block content %}
<h2>فایل‌های آپلود شده</h2>

<div class="card" style="width: 100%;padding:1rem;margin-bottom:1.5rem;">
  <h3 style="margin-top:0">آپلود فایل جدید</h3>
  <form method="post" enctype="multipart/form-data" action="{% url 'upload_file' %}" class="form" style="gap:.75rem">
    {% csrf_token %}
    <div class="form-group">
      <label for="id_file">انتخاب فایل</label>
      {{ form.file }}
    </div>
    <div class="form-group">
      <label for="id_description">توضیحات (اختیاری)</label>
      {{ form.description }}
    </div>
    <button type="submit" class="btn btn-primary" style="width: 100px;">آپلود</button>
  </form>
</div>

<div class="card" style="width: 100%;padding:1rem;margin-bottom:1rem;">
  <form method="get" class="form search-form" style="gap:.5rem;grid-template-columns: 1fr 200px 200px 100px;align-items:end">
    <div class="form-group">
      <label>جستجو</label>
      <input type="text" name="q" value="{{ q }}" placeholder="نام فایل، توضیحات یا کاربر">
    </div>
    <div class="form-group">
      <label>مرتب‌سازی</label>
      <select name="s" style="width: 100%;">
        <option value="date" {% if s == 'date' %}selected{% endif %}>تاریخ</option>
        <option value="name" {% if s == 'name' %}selected{% endif %}>نام</option>
        <option value="size" {% if s == 'size' %}selected{% endif %}>حجم</option>
        <option value="user" {% if s == 'user' %}selected{% endif %}>کاربر</option>
      </select>
    </div>
    <div class="form-group">
      <label>ترتیب</label>
      <select name="o" style="width: 100%;">
        <option value="desc" {% if o == 'desc' %}selected{% endif %}>نزولی</option>
        <option value="asc" {% if o == 'asc' %}selected{% endif %}>صعودی</option>
      </select>
    </div>
    <div>
      <button class="btn btn-sm" type="submit" style="width: 100%;">اعمال</button>
    </div>
  </form>
  {% if q %}<p class="muted" style="margin:.5rem 0 0 0">نتیجه جستجو برای: <strong>{{ q }}</strong></p>{% endif %}
 </div>

<style>
  /* Mobile responsive styles for file list */
  @media (max-width: 768px) {
    /* Hide search form grid on mobile, stack vertically */
    .search-form {
      grid-template-columns: 1fr !important;
      gap: 0.75rem !important;
    }
    
    /* Hide table on mobile */
    .file-table {
      display: none;
    }
    
    /* Show cards on mobile */
    .file-cards {
      display: block;
    }
  }
  
  @media (min-width: 769px) {
    /* Hide cards on desktop */
    .file-cards {
      display: none;
    }
    
    /* Show table on desktop */
    .file-table {
      display: table;
    }
  }
  
  /* Card styles for mobile */
  .file-card {
    background: rgba(17, 24, 39, 0.8);
    border: 1px solid #1f2937;
    border-radius: 0.75rem;
    padding: 1rem;
    margin-bottom: 1rem;
  }
  
  .file-card-row {
    display: flex;
    justify-content: space-between;
    padding: 0.4rem 0;
    border-bottom: 1px solid #1f2937;
  }
  
  .file-card-row:last-child {
    border-bottom: none;
  }
  
  .file-card-label {
    color: #94a3b8;
    font-weight: 500;
  }
  
  .file-card-value {
    color: #e5e7eb;
    text-align: left;
  }
  
  .file-card-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid #1f2937;
  }
</style>

<!-- Desktop Table View -->
<table class="file-table" style="width:100%;border-collapse:collapse;font-size:.92rem">
  <thead>
    <tr style="text-align:right;border-bottom:2px solid #1f2937">
      <th style="padding:.5rem;text-align:right">نام فایل</th>
      <th style="padding:.5rem;text-align:right">کاربر</th>
      <th style="padding:.5rem;text-align:right;width:140px">تاریخ</th>
      <th style="padding:.5rem;text-align:right;width:100px">حجم (MB)</th>
      <th style="padding:.5rem;text-align:right;width:120px">نوع/پسوند</th>
      <th style="padding:.5rem;text-align:center;width:80px">دانلود</th>
      <th style="padding:.5rem;text-align:center;width:80px">حذف</th>
      <th style="padding:.5rem;text-align:right">توضیحات</th>
    </tr>
  </thead>
  <tbody>
  {% for f in files %}
    <tr style="border-bottom:1px solid #e5e7eb">
      <td style="padding:.5rem;text-align:right">{{ f.original_name }}</td>
      <td style="padding:.5rem;text-align:right">{{ f.uploader.username }}</td>
      <td style="padding:.5rem;text-align:right">{{ f.uploaded_at|date:"Y-m-d H:i" }}</td>
      <td style="padding:.5rem;text-align:right">{{ f.size_mb }}</td>
      <td style="padding:.5rem;text-align:right">{{ f.content_type|default:f.extension }}</td>
      <td style="padding:.5rem;text-align:center"><a class="btn btn-sm" href="{% url 'download_file' f.pk %}">دانلود</a></td>
      <td style="padding:.5rem;text-align:center">
        {% if request.user.is_admin or request.user.id == f.uploader_id %}
        <form method="post" action="{% url 'delete_file' f.pk %}" onsubmit="return confirm('حذف این فایل؟');">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm" style="background:#ef4444;border-color:#ef4444;color:#fff">حذف</button>
        </form>
        {% else %}-{% endif %}
      </td>
      <td style="padding:.5rem;text-align:right">{{ f.description|default:"-" }}</td>
    </tr>
  {% empty %}
    <tr><td colspan="8" style="padding:.75rem;text-align:center">هنوز فایلی آپلود نشده است.</td></tr>
  {% endfor %}
  </tbody>
</table>

<!-- Mobile Card View -->
<div class="file-cards">
  {% for f in files %}
  <div class="file-card">
    <div class="file-card-row">
      <span class="file-card-label">نام فایل:</span>
      <span class="file-card-value">{{ f.original_name }}</span>
    </div>
    <div class="file-card-row">
      <span class="file-card-label">کاربر:</span>
      <span class="file-card-value">{{ f.uploader.username }}</span>
    </div>
    <div class="file-card-row">
      <span class="file-card-label">تاریخ:</span>
      <span class="file-card-value">{{ f.uploaded_at|date:"Y-m-d H:i" }}</span>
    </div>
    <div class="file-card-row">
      <span class="file-card-label">حجم:</span>
      <span class="file-card-value">{{ f.size_mb }} MB</span>
    </div>
    <div class="file-card-row">
      <span class="file-card-label">نوع:</span>
      <span class="file-card-value">{{ f.content_type|default:f.extension }}</span>
    </div>
    {% if f.description %}
    <div class="file-card-row">
      <span class="file-card-label">توضیحات:</span>
      <span class="file-card-value">{{ f.description }}</span>
    </div>
    {% endif %}
    <div class="file-card-actions">
      <a class="btn btn-sm" href="{% url 'download_file' f.pk %}" style="flex: 1;">دانلود</a>
      {% if request.user.is_admin or request.user.id == f.uploader_id %}
      <form method="post" action="{% url 'delete_file' f.pk %}" onsubmit="return confirm('حذف این فایل؟');" style="flex: 1;">
        {% csrf_token %}
        <button type="submit" class="btn btn-sm" style="background:#ef4444;border-color:#ef4444;color:#fff;width:100%">حذف</button>
      </form>
      {% endif %}
    </div>
  </div>
  {% empty %}
  <div class="file-card">
    <p style="text-align:center;margin:0;color:#94a3b8;">هنوز فایلی آپلود نشده است.</p>
  </div>
  {% endfor %}
</div>
{% endblock %}
